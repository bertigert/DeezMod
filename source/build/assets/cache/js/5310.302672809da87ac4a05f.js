"use strict";(self.webpackJsonpDeezer=self.webpackJsonpDeezer||[]).push([[5310],{zuHY:(e,t,n)=>{n.d(t,{MG:()=>P,NP:()=>l,ny:()=>R,VF:()=>b}),Error,Error;class o extends Error{constructor(e){super(e),this.name="UnloggedError"}}class r extends Error{constructor(e){super(e),this.name="JWTRenewError"}}class s extends Error{constructor(e){super(e),this.name="JWTFetchError"}}class i extends Error{constructor(e){super(e),this.name="JWTCacheError"}}let u=function(e){return e.ANONYMOUS="ANONYMOUS",e.ARL="ARL",e.CREDENTIALS="CREDENTIALS",e.LOGOUT="LOGOUT",e.PARTNER="PARTNER",e.RENEW="RENEW",e}({});const h={ANONYMOUS:"login/anonymous",ARL:"login/arl",CREDENTIALS:"login/credentials",LOGOUT:"logout",PARTNER:"login/partner-access-token",RENEW:"login/renew"};let l=function(e){return e.COOKIE="c",e.PAYLOAD="p",e}({});var a=n("/0+J"),c=n("MVPB"),p=n("4OMY"),T=(0,p.A)("refreshToken");const d=class{constructor(){Object.defineProperty(this,T,{writable:!0,value:void 0}),(0,c.A)(this,T)[T]=null}get(){return(0,c.A)(this,T)[T]}set(e){if("string"!=typeof e)throw new Error(`Token is invalid. String expected, got ${typeof e}.`);(0,c.A)(this,T)[T]=e}invalidate(){(0,c.A)(this,T)[T]=null}};class f extends Error{}function y(){return Math.round(Date.now()/1e3)}f.prototype.name="InvalidTokenError";var A=(0,p.A)("token"),O=(0,p.A)("approximateClientExpire"),g=(0,p.A)("requestDelay");const v=class{constructor(e,t){Object.defineProperty(this,A,{writable:!0,value:null}),Object.defineProperty(this,O,{writable:!0,value:0}),Object.defineProperty(this,g,{writable:!0,value:void 0}),(0,c.A)(this,g)[g]=t,e&&this.set(e)}get(){return(0,c.A)(this,A)[A]}set(e){if("string"!=typeof e)throw new Error(`Token is invalid. String expected, got ${typeof e}.`);let t;try{t=function(e,t){if("string"!=typeof e)throw new f("Invalid token specified: must be a string");t||(t={});const n=!0===t.header?0:1,o=e.split(".")[n];if("string"!=typeof o)throw new f(`Invalid token specified: missing part #${n+1}`);let r;try{r=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(e){return decodeURIComponent(atob(e).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}(t)}catch(e){return atob(t)}}(o)}catch(e){throw new f(`Invalid token specified: invalid base64 for part #${n+1} (${e.message})`)}try{return JSON.parse(r)}catch(e){throw new f(`Invalid token specified: invalid json for part #${n+1} (${e.message})`)}}(e)}catch(e){throw new Error("Could not decode JWT")}const{exp:n,iat:o}=t;if("number"!=typeof n||"number"!=typeof o)throw new Error("JWT does not contain any value for issuedAt or expire");const r=y()-o;(0,c.A)(this,O)[O]=n+r,(0,c.A)(this,A)[A]=e}isExpired(){return y()>(0,c.A)(this,O)[O]-(0,c.A)(this,g)[g]}isValid(){return null!==(0,c.A)(this,A)[A]&&!this.isExpired()}invalidate(){(0,c.A)(this,A)[A]=null,(0,c.A)(this,O)[O]=0}},w=({host:e,authType:t,inputType:n,tokenOutputType:o,refreshTokenOutputType:r})=>{const s=new URL(`https://${e}/${h[t]}`),i={jo:o,rto:r};let u;for(u in n&&(i.i=n),i){const e=i[u];void 0!==e&&s.searchParams.append(u,e)}return s.href};var m=(0,p.A)("refreshToken");function C(){return E.apply(this,arguments)}function E(){return(E=(0,a.A)(function*(){var e;const t=null==(e=this.refreshTokenCache)?void 0:e.get();let n,s=l.COOKIE,i="include";t&&(s=l.PAYLOAD,n=JSON.stringify({refresh_token:t}),i="omit");const h=w({host:this.host,authType:u.RENEW,inputType:s,tokenOutputType:this.tokenOutputType,refreshTokenOutputType:this.refreshTokenOutputType}),a=yield this.fetch.call(null,h,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:n,credentials:i}).catch(()=>{throw new r("Could not fetch JWT Token")});if(!a.ok)throw new o("Could not fetch JWT Token");if(this.fetchShouldHaveReponse){var c,p;const{jwt:e,refresh_token:t}=yield a.json();null==(c=this.tokenCache)||c.set(e),null==(p=this.refreshTokenCache)||p.set(t)}return null})).apply(this,arguments)}const P=class{get fetchShouldHaveReponse(){return this.tokenOutputType===l.PAYLOAD||this.refreshTokenOutputType===l.PAYLOAD}constructor({host:e,customFetch:t=globalThis.fetch,requestDelay:n=15,tokenOutputType:o=l.PAYLOAD,refreshTokenOutputType:r=l.COOKIE,refreshTokenCache:s,tokenCache:i}){Object.defineProperty(this,m,{value:C}),this.host=void 0,this.fetch=void 0,this.requestDelay=void 0,this.tokenOutputType=void 0,this.refreshTokenOutputType=void 0,this.tokenCache=null,this.refreshTokenCache=null,this.getTokenPromise=null,this.host=e,this.fetch=t,this.requestDelay=n,this.tokenOutputType=o,this.refreshTokenOutputType=r,this.tokenOutputType===l.PAYLOAD&&(this.tokenCache=i||new v(null,this.requestDelay)),this.refreshTokenOutputType===l.PAYLOAD&&(this.refreshTokenCache=s||new d)}getToken(){var e=this;return(0,a.A)(function*(){var t;if(null!=(t=e.tokenCache)&&t.isValid())return e.tokenCache.get();if(e.getTokenPromise||(e.getTokenPromise=(0,c.A)(e,m)[m]().finally(()=>{e.getTokenPromise=null})),yield e.getTokenPromise,e.tokenCache&&e.tokenCache.get()){if(e.tokenCache.isValid())return e.tokenCache.get();throw new i("Could not fetch valid JWT Token")}return null})()}invalidateCurrentToken(){var e;this.getTokenPromise=null,null==(e=this.tokenCache)||e.invalidate()}logout(){var e=this;return(0,a.A)(function*(){var t;e.invalidateCurrentToken(),null==(t=e.refreshTokenCache)||t.invalidate();const n=`https://${e.host}/${h.LOGOUT}`;yield e.fetch.call(null,n,{method:"GET",credentials:"include"}).catch(()=>{throw new Error("Could not invalidate current tokens")})})()}},R=function(e){return class extends e{constructor(...e){super(...e),this.getAnnonymousTokenPromise=null}fetchAnonymousToken(){var e=this;return(0,a.A)(function*(){const t=w({host:e.host,authType:u.ANONYMOUS,tokenOutputType:e.tokenOutputType,refreshTokenOutputType:e.refreshTokenOutputType}),n=yield e.fetch.call(null,t,{method:"GET",headers:{Accept:"application/json"}}).catch(()=>{throw new s("Could not fetch anonymous JWT Token")});if(!n.ok)throw new o(`Could not log in as anonymous. Got error ${n.status}`);if(e.fetchShouldHaveReponse){var r;const{jwt:t}=yield n.json().catch(()=>{throw new s("Response does not contain a valid JWT Token")});return null==(r=e.tokenCache)||r.set(t),t}return null})()}loginAsAnonymous(){var e=this;return(0,a.A)(function*(){return e.getAnnonymousTokenPromise||(e.getAnnonymousTokenPromise=e.fetchAnonymousToken().finally(()=>{e.getAnnonymousTokenPromise=null})),e.getAnnonymousTokenPromise})()}}},b=function(e){return class extends e{constructor(...e){super(...e),this.getArlTokenPromise=null}refreshArlLogin(e,t){var n=this;return(0,a.A)(function*(){let r;e&&(r={arl:e,account_id:t});const i=w({host:n.host,authType:u.ARL,inputType:void 0!==r?l.PAYLOAD:l.COOKIE,tokenOutputType:n.tokenOutputType,refreshTokenOutputType:n.refreshTokenOutputType}),h=void 0!==r?{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)}:{method:"POST",headers:{Accept:"application/json"},credentials:"include"},a=yield n.fetch.call(null,i,h).catch(()=>{throw new s("Could not fetch JWT Token with ARL")});if(!a.ok)throw new o(`Could not fetch JWT Token with ARL. Got error ${a.status}`);if(n.fetchShouldHaveReponse){var c,p;const{jwt:e,refresh_token:t}=yield a.json().catch(()=>{throw new s("Response does not contain valid tokens")});return null==(c=n.refreshTokenCache)||c.set(t),null==(p=n.tokenCache)||p.set(e),e}return null})()}loginWithArl(e,t){var n=this;return(0,a.A)(function*(){return n.getArlTokenPromise||(n.getArlTokenPromise=n.refreshArlLogin(e,t).finally(()=>{n.getArlTokenPromise=null})),n.getArlTokenPromise})()}}}}}]);